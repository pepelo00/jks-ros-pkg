#  Copyright (C) 2003-2011 by CHAI 3D.
#  All Rights Reserved.
#
#  $Author: seb $
#  $Date: 2012-01-24 21:01:23 -0800 (Tue, 24 Jan 2012) $
#  $Rev: 722 $


# global path
TOP_DIR = .

# commong settings
include $(TOP_DIR)/Makefile.common

# directories
OBJ_ROOT  = $(TOP_DIR)/obj
OBJ_DIR   = $(TOP_DIR)/obj/$(OS)-$(ARCH)$(GCC_VER)/$(CFG)
SRC_DIR   = $(TOP_DIR)/src
VPATH     = $(dir $(wildcard $(SRC_DIR)/* $(SRC_DIR)/*/* $(SRC_DIR)/*/*/*))

# additional libraries
ifeq ($(USE_DHD),yes)
CXXFLAGS += -I$(DHD_EXT)/include
endif

# main sources
SOURCES   = $(shell find $(SRC_DIR) -name '*.cpp')

# include dependencies
INCLUDES  = $(shell find $(SRC_DIR) -name '*.h')

# objects
OBJECTS   = $(patsubst %.cpp, $(OBJ_DIR)/%.o, $(notdir $(SOURCES)))

# external dependencies to include in static library
TMP_LIB   = $(OBJ_DIR)/$(LIB_NAME).tmp.a
EXTERNAL  = external
3DS_DIR   = $(EXTERNAL)/lib3ds
CXXFLAGS += -I$(3DS_DIR)/include
EXTLIBS   = $(3DS_DIR)/lib/$(OS)-$(ARCH)$(GCC_VER)/$(CFG)/lib3ds.a

# optional dependencies to include in static library (see Makefile.config)
ifeq ($(USE_EXTERNAL_LIBPNG), no)
PNG_DIR   = $(EXTERNAL)/libpng
CXXFLAGS += -I$(PNG_DIR)/include
EXTLIBS  += $(PNG_DIR)/lib/$(OS)-$(ARCH)$(GCC_VER)/$(CFG)/libpng.a
endif
ifeq ($(USE_EXTERNAL_LIBJPEG), no)
JPG_DIR   = $(EXTERNAL)/libjpeg
CXXFLAGS += -I$(JPG_DIR)/include
EXTLIBS  += $(JPG_DIR)/lib/$(OS)-$(ARCH)$(GCC_VER)/$(CFG)/libjpeg.a
endif
ifeq ($(USE_EXTERNAL_GIFLIB), no)
GIF_DIR   = $(EXTERNAL)/giflib
CXXFLAGS += -I$(GIF_DIR)/include
EXTLIBS  += $(GIF_DIR)/lib/$(OS)-$(ARCH)$(GCC_VER)/$(CFG)/libgif.a
endif

# examples subdirectories
SUBDIRS  = examples modules

# build rules

all: $(SUBDIRS)

$(SUBDIRS): $(BIN_DIR) lib
	$(MAKE) -C $@

lib: $(OBJ_DIR) $(LIB_DIR) $(LIB_TARGET)

$(LIB_TARGET): $(TMP_LIB) $(EXTLIBS)
	$(TOP_DIR)/libmerge.sh $(AR) $(LIB_TARGET) $?

$(TMP_LIB): $(OBJECTS)
	$(AR) $(ARFLAGS) $@ $?

$(OBJECTS): $(INCLUDES)

$(EXTLIBS): $(EXTERNAL)

$(EXTERNAL):
	$(MAKE) -C $@

$(BIN_DIR) $(LIB_DIR) $(OBJ_DIR):
	mkdir -p $@

$(OBJ_DIR)/%.o : %.cpp
	$(CXX) $(CXXFLAGS) -c -o $@ $<

.PHONY: $(EXTERNAL) $(SUBDIR)

clean:
	@for T in $(SUBDIRS); do make -C $$T $@; done
	@for T in $(EXTERNAL); do make -C $$T $@; done
	-rm -f $(OBJECTS) $(LIB_TARGET) $(TMP_LIB) *~ TAGS core *.bak #*#
	-rm -rf $(LIB_DIR) $(OBJ_DIR)
